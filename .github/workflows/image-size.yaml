name: "Image Size Check"

on: [pull_request]

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.prepare.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            ./**
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Prepare
        id: prepare
        env:
          ALL_CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: bun ./ci/index.ts

  check-size:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.matrix).include[0] != null }}
    name: size-${{ matrix.ID }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build image
        run: |
          source ci-helpers.sh
          bash ci-cleanup.sh
          bash ci-runtime-prepare.sh
          bash ci-runtime-build.sh
        env:
          RUNTIME: ${{ matrix.RUNTIME }}
          VERSION: ${{ matrix.VERSION }}
          ENFORCED_RUNTIME: ${{ matrix.ENFORCED_RUNTIME }}
          ENFORCED_VERSION: ${{ matrix.ENFORCED_VERSION }}
      - name: Get image size
        run: |
          SIZE_BYTES=$(docker image inspect open-runtimes/test-runtime --format='{{.Size}}')
          SIZE_MB=$(echo "scale=2; ${SIZE_BYTES} / 1048576" | bc)
          echo "${{ matrix.ID }}=${SIZE_MB} MB" > size.txt
          echo "Image size: ${SIZE_MB} MB"
      - name: Upload size artifact
        uses: actions/upload-artifact@v4
        with:
          name: size-${{ matrix.ID }}
          path: size.txt
          retention-days: 1

  report:
    needs: check-size
    if: always() && needs.check-size.result != 'skipped'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Download all size artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: size-*
          path: sizes
      - name: Build comment body
        run: |
          echo "## Docker Image Sizes" > comment.md
          echo "" >> comment.md
          echo "| Runtime | Size |" >> comment.md
          echo "|---------|------|" >> comment.md
          for file in sizes/*/size.txt; do
            IFS='=' read -r name size < "$file"
            echo "| \`${name}\` | ${size} |" >> comment.md
          done
      - name: Find existing comment
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: '## Docker Image Sizes'
      - name: Create or update comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          edit-mode: replace
          body-path: comment.md

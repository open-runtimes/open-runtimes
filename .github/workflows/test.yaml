name: "Testing OpenRuntimes"

on: [ pull_request ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.prepare.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            ./**
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Prepare
        id: prepare
        env:
          ALL_CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: bun ./ci/index.ts

  shell-format-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install shfmt
        run: |
          wget -O shfmt https://github.com/mvdan/sh/releases/download/v3.8.0/shfmt_v3.8.0_linux_amd64
          chmod +x shfmt
          sudo mv shfmt /usr/local/bin/
      - name: Check shell script formatting
        run: shfmt -d .

  shell-script-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install shellcheck
        run: |
          wget -O shellcheck.tar.xz https://github.com/koalaman/shellcheck/releases/download/v0.9.0/shellcheck-v0.9.0.linux.x86_64.tar.xz
          tar -xf shellcheck.tar.xz
          sudo mv shellcheck-v0.9.0/shellcheck /usr/local/bin/
      - name: Check shell script quality
        run: |
          # -S warning: Only fail on warnings and errors, not info
          # -e SC1091: Ignore missing source warning
          # {} +: Pass multiple files to shellcheck at once for efficiency
          find . -name "*.sh" \
            -not -path "./.git/*" \
            -not -path "./runtimes/.test/*" \
            -not -path "./**/node_modules/*" \
            -not -path "./runtimes/java/versions/latest/gradlew" \
            -not -path "./runtimes/kotlin/versions/latest/gradlew" \
            -exec shellcheck -e SC1091 -S warning {} +

  open-runtimes:
    needs: prepare
    name: ${{ matrix.ID }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
      - name: Setup Composer
        run: |
          php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
          php composer-setup.php
          php -r "unlink('composer-setup.php');"
          mv composer.phar /usr/local/bin/composer
      - name: Install dependencies
        run: composer install
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Run tests
        timeout-minutes: 15
        working-directory: ./
        run: bash ci_tests.sh
        env:
          RUNTIME: ${{ matrix.RUNTIME }}
          ENTRYPOINT: ${{ matrix.ENTRYPOINT }}
          VERSION: ${{ matrix.VERSION }}
          INSTALL_COMMAND: ${{ matrix.INSTALL_COMMAND }}
          START_COMMAND: ${{ matrix.START_COMMAND }}
          TOOLS: ${{ matrix.TOOLS }}
          FORMATTER_CHECK: ${{ matrix.FORMATTER_CHECK }}
          FORMATTER_PREPARE: ${{ matrix.FORMATTER_PREPARE }}
          TEST_CLASS: ${{ matrix.TEST_CLASS }}
          OUTPUT_DIRECTORY: ${{ matrix.OUTPUT_DIRECTORY }}
          ENFORCED_RUNTIME: ${{ matrix.ENFORCED_RUNTIME }}
          ENFORCED_VERSION: ${{ matrix.ENFORCED_VERSION }}
      - name: Get image size
        id: size
        if: always()
        run: |
          SIZE_BYTES=$(docker image inspect open-runtimes/test-runtime --format='{{.Size}}' 2>/dev/null || echo "0")
          SIZE_MB=$(echo "scale=2; ${SIZE_BYTES} / 1048576" | bc)
          echo "mb=${SIZE_MB}" >> "$GITHUB_OUTPUT"
      - name: Report image size
        if: always() && steps.size.outputs.mb && steps.size.outputs.mb != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const marker = '<!-- image-size-check -->';
            const id = '${{ matrix.ID }}';
            const size = '${{ steps.size.outputs.mb }} MB';
            const pr = context.payload.pull_request.number;
            const opts = { owner: context.repo.owner, repo: context.repo.repo };

            for (let attempt = 0; attempt < 5; attempt++) {
              if (attempt > 0)
                await new Promise(r => setTimeout(r, Math.floor(Math.random() * 5000) + 2000));

              const { data: comments } = await github.rest.issues.listComments({ ...opts, issue_number: pr });
              const comment = comments.find(c => c.body?.includes(marker));

              const rows = new Map();
              for (const m of (comment?.body ?? '').matchAll(/^\| `(.+?)` \| (.+?) \|$/gm))
                rows.set(m[1], m[2]);
              rows.set(id, size);

              const sorted = [...rows.entries()].sort((a, b) => a[0].localeCompare(b[0]));
              let body = `${marker}\n## Docker Image Sizes\n\n| Runtime | Size |\n|---------|------|\n`;
              for (const [n, s] of sorted) body += `| \`${n}\` | ${s} |\n`;

              if (comment)
                await github.rest.issues.updateComment({ ...opts, comment_id: comment.id, body });
              else
                await github.rest.issues.createComment({ ...opts, issue_number: pr, body });

              await new Promise(r => setTimeout(r, 1000));
              const { data: verify } = await github.rest.issues.listComments({ ...opts, issue_number: pr });
              if (verify.find(c => c.body?.includes(marker))?.body?.includes(`| \`${id}\` |`)) break;
            }
